{% extends 'layout.html.twig' %}
{% set active = infos[0].info.sail %}
{% set bodyId = 'high' %}

{% if infos|length > 1 %}
    {% set title = 'Race progress for %boat%'|trans({ '%boat%': [infos[0].info.skipper, infos[1].info.skipper]|join(' & ') }) %}
    {% set extra_meta = 'Race progress for %boat%'|trans({ '%boat%': [infos[0].info.skipper, infos[1].info.skipper]|join(' & ') }) %}
    {% set compare_lbl = '<i class="icon-sign-blank" style="color: #' ~ infos[1].info.color ~ '"></i> ' ~ infos[1].info.skipper %}
{% else %}
    {% set title = 'Race progress for %boat%'|trans({'%boat%': infos[0].info.skipper}) %}
    {% set extra_meta = 'Race progress for %boat%'|trans({'%boat%': infos[0].info.skipper}) %}
    {% set compare_lbl = 'Compare with...'|trans() %}
{% endif %}

{% block container_content %}

    <div class="row-fluid">
        {% for info in infos %}
        <div class="span6 sail">
            <table class="table">
                <tr>
                    <td colspan="2">
                        <h3>
                        {% if loop.index0 == 0 %}
                            <i class="icon-sign-blank" style="color: #{{ info.info.color }}"></i> #{{ info.info.rank }} {{ info.info.skipper }}
                        {% else %}
                            #{{ info.info.rank }}
                            <div class="btn-group">
                                <a class="btn dropdown-toggle" data-toggle="dropdown" href="#">
                                    {{ compare_lbl|raw }}
                                    <span class="caret"></span>
                                </a>
                                <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenu">
                                    {% for sail, skipper in sk %}
                                    <li>
                                        <a href="/{{ app.request.locale }}/sail/{{ infos[0].info.sail }}-{{ sail }}"><i class="icon-sign-blank" style="color: #{{ skipper.color }}"></i> {{ skipper.skipper }}</a>
                                    {% endfor %}
                                </ul>
                            </div>
                        {% endif %}
                        </h3>
                    </td>
                    <td colspan="2">
                        <div class="progress">
                            <div class="bar" style="width:{{ '%.2f' | format((24016.60-info.info.dtf)/24016.60*100) }}%"></div>
                            <div class="togo">
                                {{ info.info.dtf }} <abbr title="{{ 'Nautical Miles'|trans }}">{{ 'nm'|trans }}</abbr>
                            </div>
                        </div>
                    </td>
                </tr>
                <tr>
                    <th>{{ 'Last ranking'|trans }}</th>
                    <td>{{ info.info.timestamp|date }}</td>
                    <th>{{ 'Boat'|trans }}</th>
                    <td>{{ info.info.boat }} [{{ info.info.sail }}]</td>
                </tr>
                <tr>
                    <th>{{ 'Heading'|trans }}</th>
                    <td>{{ info.info['1hour_heading'] }}&deg;</td>
                    <th>{{ 'Coordinates'|trans }}</th>
                    <td>{{ info.info.lat_dms }} - {{ info.info.lon_dms }}</td>
                </tr>
                <tr>
                    <th>{{ 'Distance to finish'|trans }}</th>
                    <td>
                        {{ info.info.dtf }} <abbr title="{{ 'Nautical Miles'|trans }}">{{ 'nm'|trans }}</abbr>
                    </td>
                    <th>{{ 'Distance to leader'|trans }}</th>
                    <td>
                        {{ info.info.dtl }} <abbr title="{{ 'Nautical Miles'|trans }}">{{ 'nm'|trans }}</abbr>
                    </td>
                </tr>
                <tr>
                    <th>{{ 'Real total distance travelled'|trans }} * /<br>{{ 'Overall average speed'|trans }} **</th>
                    <td>{{ info.info.total_distance }} <abbr title="{{ 'Nautical Miles'|trans }}">{{ 'nm'|trans }}</abbr> / {{ '%.1f' | format(info.info.total_distance / (info.info.time_travelled / (60 * 60))) }} <abbr title="{{ 'Knots'|trans }}">{{ 'kn'|trans }}</abbr></td>
                    <th>{{ 'Coordinates'|trans }}</th>
                    <td>{{ info.info.lat_dms }} - {{ info.info.lon_dms }}</td>
                </tr>
                <tr class="tooltips">
                    <td colspan="2">
                        <strong>{{ 'JSON'|trans }}</strong>
                        <a target="_blank" href="/json/sail/{{ info.info.sail }}.json" rel="tooltip" data-placement="right" title="{{ 'Download JSON'|trans }}"><i class="icon-download"></i> /json/sail/{{ info.info.sail }}.json</a>
                    </td>
                    <td colspan="2">
                        <strong>{{ 'KMZ'|trans }}</strong>
                        <a target="_blank" href="/json/sail/{{ info.info.sail }}.kmz" rel="tooltip" data-placement="right" title="{{ 'Download KMZ'|trans }}"><i class="icon-globe"></i> /json/sail/{{ info.info.sail }}.kmz</a>
                    </td>
                </tr>
            </table>
        </div>
        {% endfor %}

        {% if infos|length == 1 %}
            <div class="span6">
                <table class="table">
                    <tr>
                        <td colspan="2">
                            <h3>
                                <div class="btn-group">
                                    <a class="btn dropdown-toggle" data-toggle="dropdown" href="#">
                                        {{ compare_lbl }}
                                        <span class="caret"></span>
                                    </a>
                                    <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenu">
                                        {% for sail, skipper in sk %}
                                        <li>
                                            <a href="/{{ app.request.locale }}/sail/{{ infos[0].info.sail }}-{{ sail }}"><i class="icon-sign-blank" style="color: #{{ skipper.color }}"></i> {{ skipper.skipper }}</a>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </h3>
                        </td>
                    </tr>
                </table>
            </div>
        {% endif %}
    </div>{# row-fluid #}
    <div class="row-fluid">
        <p>
            * {{ 'Sum of the distances travelled between each ranking since race start'|trans }}<br>
            ** {{ 'Average speed since race start based on the real distance travelled'|trans }}
        </p>
    </div>

    <div class="row-fluid">
        <div class="span6">
            <h3>{{ 'Rank'|trans }}</h3>
            <div id="rank" class="chart"></div>
        </div>
        <div class="span6">
            <h3>{{ 'Distance To Leader'|trans }}</h3>
            <div id="dtl" class="chart"></div>
        </div>
    </div>
    <div class="row-fluid">
        <div class="span6">
            <h3>{{ 'Distance last 24 hours'|trans }}</h3>
            <div id="24hour_distance" class="chart"></div>
        </div>
        <div class="span6">
            <h3>{{ 'Speed last 24 hours'|trans }}</h3>
            <div id="24hour_speed" class="chart"></div>
        </div>
    </div>
    {#
    <div class="row-fluid">
        <div class="span6">
            <h3>{{ 'Progress'|trans }}</h3>
            <div id="dtl_diff" class="chart"></div>
        </div>
    </div>
    #}

    <script type="text/javascript">
    $(function() {
        var data, $rank = $("#rank"), $dtl = $("#dtl"), $24hour_distance = $("#24hour_distance"), $24hour_speed = $("#24hour_speed"), $dtl_diff = $("dtl_diff");
        var options = {
            series: {
                lines: {
                    steps: false
                }
            },
            xaxis: {
                mode: 'time',
                timezone: 'browser'
            },
            yaxis: {
                min: 1,
            },
            legend: {
                backgroundOpacity: 0,
                noColumns: 2
            }
        };

        data = [];
        {% for info in infos %}
        data.push({{ info.dtl|raw }});
        {% endfor %}
        $.plot($dtl, data, options);

        data = [];
        {% for info in infos %}
        data.push({{ info.t24hour_distance|raw }});
        {% endfor %}
        $.plot($24hour_distance, data, options);

        data = [];
        {% for info in infos %}
        data.push({{ info.t24hour_speed|raw }});
        {% endfor %}
        $.plot($24hour_speed, data, options);
        {#
        data = [];
        {% for info in infos %}
        data.push({{ info.tdtl_diff|raw }});
        {% endfor %}
        $.plot($dtl_diff, data, options);
        #}

        options.yaxis.transform = function (v) { return -v; };
        options.yaxis.tickSize = 2;
        options.yaxis.ticks = 1;
        options.yaxis.max = 20;
        options.series.lines.steps = true;
        data = [];
        {% for info in infos %}
        data.push({{ info.rank|raw }});
        {% endfor %}
        $.plot($rank, data, options);
    });
    </script>
{% endblock %}
